function Grow(){this.calls=[],this.call=function(n){if(!n)var n={};return{id:uuidv4(),time:new Date.now,context:n.context,state:n.state}},this.energyAt=function(n){var s=0,l=n.diode;return l&&n.target&&(xNormal=n.target.x/l3.ai.unitScale(n.target.unit)+l.position.sox/l.position.unitScale,zNormal=n.target.z/l3.ai.unitScale(n.target.unit)+l.position.soz/l.position.unitScale,yNormal=l.parent.hangHeight/l.parent.unitScale,s+=l[n.lightUnit]*(Math.pow(yNormal,1+3.8317)/Math.pow(Math.sqrt(Math.pow(xNormal,2)+Math.pow(zNormal,2)+Math.pow(yNormal,2)),3+3.8317))),s},this.calculateCoverage=function(n){var s={id:n.id||uuidv4(),uuid:uuidv4()};if(!n)var n={};if(n.lights);else if(!n.lightSources)return console.error("you need to include an array of lights"),!1;if(s.lightSources=n.lights||n.lightSources,n.render&&!n.scene&&console.error("you need to include a l3 scene if you want to render the map"),s.scene=n.scene,s.ratio=n.scene.ratio||n.ratio,s.coverageMaps=n.coverageMaps||[],s.lightSources.forEach(function(r){var c=r;c.leds&&c.makeDiodes({render:!1})}),s.unit="cm",n.frontOn){s.frontOn=!0;var l="front";posAdjY="z",posAdjZ="y",labelRotationNormal=0}else{var l="bottom";posAdjY="y",posAdjZ="z",labelRotationNormal=-90}0<s.coverageMaps.length&&s.coverageMaps.forEach(r=>{var g=r;g.position||(g.position={}),g=returnJsonConcat(g,{map:[],unit:g.unit||"cm",width:g.width||0,depth:g.depth||0,height:g.height||g.depth||0,xResolution:g.xResolution||g.resolution||g.width||0,zResolution:g.zResolution||g.resolution||g.depth||0,yResolution:g.yResolution||g.resolution||g.zResolution||0,type:g.type||"2d",id:g.id||uuidv4(),lumensMax:0,luxMax:0,photonsMax:0,ppfdMax:0,wattageMax:0,wattagePsqmMax:0,lumensTotal:0,luxTotal:0,photonsTotal:0,ppfdTotal:0,wattageTotal:0,wattagePsqmTotal:0,lumensAvg:0,luxAvg:0,photonsAvg:0,ppfdAvg:0,wattageAvg:0,wattagePsqmAvg:0,object:{},position:{x:g.position.x||0,y:g.position.y||0,z:g.position.z||0,unit:g.position.unit||g.unit||"cm",rx:g.position.rx||0,ry:g.position.ry||0,rz:g.position.rz||0,type:g.position.type||"center"}}),g.width=Math.floor(g.width/g.xResolution)*g.xResolution,g.depth=Math.floor(g.depth/g.zResolution)*g.zResolution,g.height=Math.floor(g.height/g.yResolution)*g.yResolution,g.area=(g.width*g.depth).toFixed(2),g.object=new Cube({width:g.width,height:g.height,depth:g.depth,unit:g.unit,type:"canvas",scene:s.scene,id:g.id+"object",canvas:{type:"rects",rects:g.map,size:{height:!0,width:!0,inherit:!0},pxRects:[],render:!1},group:{id:"coverageMaps"+s.uuid,class:"coverageMaps "+s.scene.theme},class:"coverageMap "+s.scene.theme,position:{x:g.position.x,y:g.position.y,z:g.position.z,unit:g.unit},ratio:s.scene.ratio||s.ratio||n.mapRatio||88}),n.dimensionLabels&&g.object.children.push(new Cube({width:g.width,height:5,sides:[],unit:g.unit,id:uuidv4(),class:"coverageMapFullLabel width ",data:{text:"<div class=\"data\">"+g.width+g.unit+"</div>"},parent:g.object,position:{rx:labelRotationNormal,y:g.resolution/3,unit:g.unit}}),new Cube({height:g.depth,width:5,sides:[],unit:g.unit,id:uuidv4()+"coverageMapLabel",class:"coverageMapFullLabel depth ",data:{text:"<div class=\"data\">"+g.depth+g.unit+"</div>"},parent:g.object,position:{rx:labelRotationNormal,x:-(g.resolution/2),z:0,y:0,unit:g.unit}}));for(var m,h=0;h<=g.width-g.xResolution;h+=g.xResolution){m=h;for(var w,v=0;v<=g.depth-g.zResolution;v+=g.zResolution)if(w=v,"3d"==g.type)for(var S,j=0;j<=g.height-g.yResolution;j+=g.yResolution)S=j;else{var C=g.xResolution*g.zResolution,L={width:g.xResolution,depth:g.zResolution,height:g.yResolution,unit:g.unit,position:{x:m+g.xResolution/2,z:w+g.zResolution/2,y:0,unit:g.unit,type:"center"},type:"2d",lumens:0,lux:0,photons:0,ppfd:0,wattage:0,wattagePsqm:0,area:C,areaNormalised:C/l3.ai.convertAreaScale(g.unit,"m")};if(s.frontOn)var P=0;else var P=g.zResolution/2;L.rect={width:L.width,depth:L.depth,height:L.height,unit:L.unit,position:{x:L.position.x-g.xResolution/2,y:L.position[posAdjY]-g.yResolution/2,z:L.position[posAdjZ]-P,unit:L.position.unit}},g.map.push(L)}}s.lightSources.forEach(k=>{var H=k;g.hangHeight=H.hangHeight,g.map.forEach(D=>{H.leds.diodes.forEach(N=>{D.lux+=this.energyAt({lightUnit:"lux",target:{x:D.position.x-g.width/2,z:D.position.z-g.depth/2,unit:g.unit},diode:N}),D.ppfd+=this.energyAt({lightUnit:"ppfd",target:{x:D.position.x-g.width/2,z:D.position.z-g.depth/2,unit:g.unit},diode:N}),D.wattagePsqm+=this.energyAt({lightUnit:"wattagePsqm",target:{x:D.position.x-g.width/2,z:D.position.z-g.depth/2,unit:g.unit},diode:N}),g.lumensMax<D.lumens&&(g.lumensMax=D.lumens),g.ppfdMax<D.ppfd&&(g.ppfdMax=D.ppfd),g.wattagePsqmMax<D.wattagePsqm&&(g.wattagePsqmMax=D.wattagePsqm),g.luxMax<D.lux&&(g.luxMax=D.lux)})})}),g.map.forEach(k=>{for(var D,H=0,T=0;T<s.lightSources.length;T++)if(!D){var D=this.normalize(s.lightSources[T].position.z-(k.position.z-g.depth/2));H=s.lightSources[T].hangHeight}else D<this.normalize(s.lightSources[T].position.z-(k.position.z-g.depth/2))&&(H=s.lightSources[T].hangHeight,D=this.normalize(s.lightSources[T].position.z-(k.position.z-g.depth/2)));k.photons=k.area/l3.ai.convertAreaScale(g.unit,"m")*k.ppfd,k.lumens=k.area/l3.ai.convertAreaScale(g.unit,"m")*k.lux,k.wattage=k.area/l3.ai.convertAreaScale(g.unit,"m")*k.wattagePsqm,g.wattageTotal+=k.wattage,g.wattagePsqmTotal+=k.wattagePsqm,g.lumensTotal+=k.lumens,g.luxTotal+=k.lux,g.ppfdTotal+=k.ppfd,g.photonsTotal+=k.photons,g.wattageAvg=g.wattageTotal/g.map.length,g.wattagePsqmAvg=g.wattagePsqmTotal/g.map.length,g.lumensAvg=g.lumensTotal/g.map.length,g.luxAvg=g.luxTotal/g.map.length,g.ppfdAvg=g.ppfdTotal/g.map.length,g.photonsAvg=g.photonsTotal/g.map.length;var N=[255,43,151];k.rect.fillStyle="rgba("+N[0]+","+N[1]+","+N[2]+","+k.ppfd/g.ppfdMax+")"});var A=[{key:"width",text:"Width:  <div class='unit'><div class='value'>"+g.width+"</div>"+g.unit+"</div>",group:"coverageMapData"},{key:"depth",text:"Depth:  <div class='unit'><div class='value'>"+g.depth+"</div>"+g.unit+"</div>",group:"coverageMapData"},{key:"areaNormalised",text:"Area:  <div class='unit'><div class='value'>"+g.area/l3.ai.convertAreaScale(g.unit,"m")+"</div>m<div class=\"squared\">2</div></div>",group:"coverageMapData",round:4},{key:"lumensTotal",text:"Total Lumens:  <div class='unit'><div class='value'>"+g.lumensTotal.toFixed(0)+"</div>",group:"coverageMapData"},{key:"wattageTotal",text:"Total Wattage:  <div class='unit'><div class='value'>"+g.wattageTotal.toFixed(0)+"</div>",group:"coverageMapData"},{key:"ppfdAvg",text:"Avg PPFD (umols/m2/s):  <div class='unit'><div class='value'>"+g.ppfdAvg.toFixed(0)+"</div>",group:"coverageMapData"},{key:"luxAvg",text:"Avg Lux (lumens/m2):  <div class='unit'><div class='value'>"+g.luxAvg.toFixed(0)+"</div>",group:"coverageMapData"},{key:"position-type",text:"Coordinate position:  <div class='unit'><div class='value capitalise'>"+g.position.type+"</div>",group:"coverageMapData"}];A.forEach(k=>{if(k.group)var H={class:k.group,id:g.object.id+k.group,positioner:!0};new Cube({class:"coverageMapDataItem "+k.key,parent:g.object,sides:[],group:H,data:{text:"<div class=\"data-container\">"+k.text+"</div"}})}),g.object.renderCanvas();var q=g.xResolution*g.zResolution,O=[{key:"width",text:"Tile Width: <div class='unit'><div class='value'>"+g.xResolution+"</div>"+g.unit+"</div>",group:"coverageSquareData"},{key:"depth",text:"Tile Depth: <div class='unit'><div class='value'>"+g.zResolution+"</div>"+g.unit+"</div>",group:"coverageSquareData"},{key:"areaNormalised",text:"Tile Area:  <div class='unit'><div class='value'>"+g.zResolution*g.xResolution/l3.ai.convertAreaScale(g.unit,"m")+"</div>m<div class=\"squared\">2</div></div>",group:"coverageSquareData",round:4},{key:"position-x",text:"At X: <div class='value'>0</div>",group:"coverageSquareData"},{key:"position-z",text:"At Z: <div class='value'>0</div>",group:"coverageSquareData"},{key:"ppfd",text:"PPFD (umols/m2/s): <div class='value'>0</div>",group:"coverageSquareData"},{key:"lux",text:"Lux (lumens/m2): <div class='value'>0</div>",group:"coverageSquareData"},{key:"photons",text:"Photons (umols): <div class='value'>0</div>",group:"coverageSquareData",round:2},{key:"lumens",text:"Lumens: <div class='value'>0</div>",group:"coverageSquareData",round:2},{key:"wattage",text:"Wattage: <div class='value'>0</div>",group:"coverageSquareData",round:2}];O.forEach(k=>{if(k.group)var H={class:k.group,id:g.object.id+k.group,positioner:!0};new Cube({class:"coverageMapDataItem "+k.key,parent:g.object,sides:[],group:H,data:{text:k.text}})}),g.object.canvas.rects.forEach((k,M)=>{var H={width:k.rect.width/l3.ai.unitScale(k.rect.unit)*g.object.scene.pxr,height:k.rect.height/l3.ai.unitScale(k.rect.unit)*g.object.scene.pxr,unit:"px",position:{x:k.rect.position.x/l3.ai.unitScale(k.rect.unit)*g.object.scene.pxr,y:k.rect.position.y/l3.ai.unitScale(k.rect.unit)*g.object.scene.pxr,z:k.rect.position.z/l3.ai.unitScale(k.rect.unit)*g.object.scene.pxr,unit:"px"},zIndex:20,index:M};g.object.canvas.pxRects.push(H)}),g.object.canvas.canvas.onmousemove=function(k){var M=parseInt(k.offsetX),H=parseInt(k.offsetY),D=l3.ai.findCurrentRect({mouse:{x:M,y:H},rects:g.object.canvas.pxRects}),T=g.map[D.index];O.forEach(N=>{g.object.children.forEach(W=>{if(W.group&&-1<W.group.class.indexOf(N.group)&&-1<W.class.indexOf(N.key)){var I=N.key.replace("-",".");if("number"==typeof T[I])var Y=N.round||0,X=Object.byString(T,I).toFixed(Y);else var X=Object.byString(T,I);d3.select($("#"+g.object.id+" #"+W.id+"."+N.key+" .value").get(0)).html(X)}})})}})},this.normalize=function(n){return Math.sqrt(Math.pow(n,2))},this.wavelengthColourCodes=[],this.firstColourCode=[179,34,255],this.wavelengthRanges=[{colour:"violet",wavelengthRange:{min:400,max:440},rgbObj:{r:57,g:220,b:255},rgb:[70,140,255]},{colour:"blue",wavelengthRange:{min:440,max:485}},{colour:"cyan",wavelengthRange:{min:485,max:500}},{colour:"green",wavelengthRange:{min:500,max:565}},{colour:"yellow",wavelengthRange:{min:565,max:590}},{colour:"orange",wavelengthRange:{min:590,max:600}},{colour:"red",wavelengthRange:{min:600,max:680},rgbObj:{r:255,g:0,b:1},rgb:[255,0,5]}],this.customColours=[{colour:"Purple",wavelength:"Purple",rgbObj:{r:105,g:52,b:147},rgb:[105,52,147],rgbString:"rgb(105, 52, 147)"},{colour:"Blue",wavelength:"Blue",rgbObj:{r:22,g:112,b:195},rgb:[22,112,195],rgbString:"rgb(22, 112, 195)"},{colour:"Cyan",wavelength:"Cyan",rgbObj:{r:70,g:201,b:250},rgb:[70,201,250],rgbString:"rgb(70, 201, 250)"},{colour:"Green",wavelength:"Green",rgbObj:{r:128,g:188,b:24},rgb:[128,188,24],rgbString:"rgb(128, 188, 24)"},{colour:"Yellow",wavelength:"Yellow",rgbObj:{r:255,g:224,b:59},rgb:[255,224,59],rgbString:"rgb(255, 224, 59)"},{colour:"Orange",wavelength:"Orange",rgbObj:{r:255,g:160,b:61},rgb:[255,160,61],rgbString:"rgb(255, 160, 61)"},{colour:"Red",wavelength:"Red",rgbObj:{r:255,g:65,b:65},rgb:[255,65,65],rgbString:"rgb(255, 65, 65)"},{colour:"yellow",wavelength:"k3000",rgbObj:{r:255,g:191,b:116},rgb:[255,191,116],rgbString:"rgb(255, 191, 116)"},{colour:"infra red",wavelength:"nm730",rgbObj:{r:222,g:0,b:4},rgb:[221,0,0]},{colour:"UVA",wavelength:"UVA",rgbObj:{r:203,g:44,b:255},rgb:[203,44,255]}],this.interpolateHSL=function(n,s,l){3>arguments.length&&(l=0.5);for(var r=ROT.Color.rgb2hsl(n),u=ROT.Color.rgb2hsl(s),c=0;3>c;c++)r[c]+=l*(u[c]-r[c]);return r},this.makeColours=function(n){if(!n)var n={};for(var s=n.minWavelength||this.wavelengthRanges[0].wavelengthRange.min||280,l=n.maxWavelength||this.wavelengthRanges[this.wavelengthRanges.length-1].wavelengthRange.max||820,r=[this.wavelengthRanges[0].rgbObj.r,this.wavelengthRanges[0].rgbObj.g,this.wavelengthRanges[0].rgbObj.b],u=[this.wavelengthRanges[this.wavelengthRanges.length-1].rgbObj.r,this.wavelengthRanges[this.wavelengthRanges.length-1].rgbObj.g,this.wavelengthRanges[this.wavelengthRanges.length-1].rgbObj.b],g=1/(l-s),h=s;h<l;h++)for(var m=h-s,v=ROT.Color.interpolateHSL(r,u,g+g*m),w=h,j=0;j<this.wavelengthRanges.length;j++)if(this.wavelengthRanges[j].wavelengthRange.min<=w&&w<this.wavelengthRanges[j].wavelengthRange.max){var S={r:v[0],g:v[1],b:v[2]};this.wavelengthColourCodes["nm"+w]={curWavelength:w,colour:this.wavelengthRanges[j].colour,rgb:v,rgbObj:S,rgbString:"rgba("+S.r+","+S.g+","+S.b+",1)"}}for(var C=0;C<this.customColours.length;C++)this.wavelengthColourCodes[this.customColours[C].wavelength]=this.customColours[C]},this.makeColours(),this.getColour=function(n){for(var s=0;s<this.wavelengthRanges.length;s++)if(this.wavelengthRanges[s].wavelengthRange.min<=n&&n<this.wavelengthRanges[s].wavelengthRange.max)return this.wavelengthRanges[s].colour},this.getColourCode=function(n){for(var n=0;n<this.wavelengthColourCodes.length;n++)if(n==this.wavelengthColourCodes[n].wavelength)return"Number"==typeof n&&(1e3>n?n="nm"+n:1e3<n&&(n="k"+n)),this.wavelengthColourCodes[n].rgbString}}var grow={ai:new Grow};function Growroom(o,n){if(jsonConcat(this,o),!o)var o={};if(!n)var n={};if(this.height=n.height||o.height,this.width=n.width||o.width,this.depth=n.depth||o.depth,this.ratio=n.ratio||o.ratio||100,this.id=n.id||o.id||"defaultRoom",this.uuid=n.uuid||o.uuid||uuidv4(),this.class=n.class||o.class||"tent",this.scene=n.scene||o.scene,this.render=n.render||o.render||!0,this.lights=n.lights||o.lights||[],this.position=n.position||o.position||{x:0,y:0,z:0},this.unit=n.unit||o.unit||"m",this.mongoId=n.mongoId||o.mongoId,this.minPxWidth=n.minPxWidth||o.minPxWidth,o.object&&jsonConcat(this.object,o.object),n.object&&jsonConcat(this.object,n.object),this.object=new Cube({height:this.height,width:this.width,depth:this.depth,unit:this.unit,ratio:this.ratio,scene:this.scene,id:this.uuid,class:this.class,sizeSelf:n.sizeSelf||o.sizeSelf||!0,minPxWidth:n.minPxWidth||o.minPxWidth||this.minPxWidth,position:this.position||{x:0,y:0,z:0}}),this.dimensions={width:{dimension:"width",value:this.width},depth:{dimension:"depth",value:this.depth},height:{dimension:"height",value:this.height}},this.labels=n.labels||o.labels||[],this.coverage=[],this.addLight=function(s){this.lights.push(s.light)},this.addChildObject=function(){},this.renderDimensionLabels=function(s){if("3d"==s.dimensions)for(prop in this.dimensions)if(this.dimensions.hasOwnProperty(prop))if("width"==this.dimensions[prop].dimension){var l=new Cube({type:"2d",height:0,width:20,depth:0,unit:"cm",class:this.class+"DimensionLabel",id:this.uuid+"labelFor"+this.dimensions[prop].dimension,group:{class:"dimensionLabels",id:this.uuid+"dimensionLabels"},parent:this.object,position:{x:this.object.width/this.object.unitScale/2+this.object.width/this.object.unitScale/9,y:5e-3,z:0,unit:"m"}});this.labels.push(l);var r="<div class=\"dimensionLabel\"><div>"+this.dimensions[prop].dimension+": </div><div>"+this.object.width+""+this.object.unit+"</div></div></div>";$("#"+this.scene.id+" #"+l.id).append(r)}else if("depth"==this.dimensions[prop].dimension){var l=new Cube({type:"2d",height:20,width:80,depth:2,unit:"cm",class:this.class+"DimensionLabel",id:this.uuid+"labelFor"+this.dimensions[prop].dimension,group:{class:"dimensionLabels",id:this.uuid+"dimensionLabels"},parent:this.object,position:{x:0,y:5e-3,z:this.object.depth/this.object.unitScale/2,unit:"m"}});this.labels.push(l);var r="<div class=\"dimensionLabel\"><div>"+this.dimensions[prop].dimension+": </div><div>"+this.object.depth+""+this.object.unit+"</div></div></div>";$("#"+this.scene.id+" #"+l.id).append(r)}else if("height"==this.dimensions[prop].dimension){var l=new Cube({type:"2d",height:20,width:80,depth:2,unit:"cm",class:this.class+"DimensionLabel",id:this.uuid+"labelFor"+this.dimensions[prop].dimension,group:{class:"dimensionLabels",id:this.uuid+"dimensionLabels"},parent:this.object,position:{x:0,y:this.object.height/this.object.unitScale/2,z:0,unit:"m"}});this.labels.push(l);var r="<div class=\"dimensionLabel\"><div>"+this.dimensions[prop].dimension+": </div><div>"+this.object.height+""+this.object.unit+"</div></div></div>";$("#"+this.scene.id+" #"+l.id).append(r)}},o.renderDimensionLabels?this.renderDimensionLabels({dimensions:this.object.type}):n.renderDimensionLabels&&this.renderDimensionLabels({dimensions:this.object.type}),this.renderCoverage=function(s){s.class=s.class||"floorCoverage",this.coverage[s.id]=[],s.yPlane||(s.yPlane=0),s.unitScale="m"==s.unit?1:"cm"==s.unit?100:"mm"==s.unit?1e3:"um"==s.unit?1e4:1;for(var l=0;l<Math.ceil(this.width/this.object.unitScale/(s.resolution/s.unitScale));l++)for(var r=0;r<Math.ceil(this.depth/this.object.unitScale/(s.resolution/s.unitScale));r++)if(s.includeY)for(var u=0;u<Math.ceil(this.height/this.object.unitScale/(s.resolution/s.unitScale));u++){var c=u,g={};g.unit=s.unit,g.type=s.position.type||"normal",s.position&&("center"==s.position.type?(g.x=(l*(s.resolution/s.unitScale)+s.resolution/s.unitScale/2+(this.width/this.object.unitScale-Math.ceil(this.width/this.object.unitScale/(s.resolution/s.unitScale))*(s.resolution/s.unitScale))/2)*s.unitScale,g.z=(r*(s.resolution/s.unitScale)+s.resolution/s.unitScale/2+(this.depth/this.object.unitScale-Math.ceil(this.depth/this.object.unitScale/(s.resolution/s.unitScale))*(s.resolution/s.unitScale))/2)*s.unitScale,!s.includeY&&(g.y=(s.yPlane+s.resolution/s.unitScale/2)*s.unitScale)):(g.x=l*(s.resolution/s.unitScale)*s.unitScale*s.unitScale,g.z=r*(s.resolution/s.unitScale)*s.unitScale*s.unitScale,g.y=s.yPlane)),g.y="center"==g.type?(c*s.resolution+s.resolution/2)*s.unitScale:(c*s.resolution+s.yPlane)*s.unitScale;var h=new Cube({width:s.squareSize||0.05,height:s.squareSize||0.05,depth:s.squareSize||0.05,unit:s.unit||"m",sides:s.sides||["bottom","front","top","left","right","back"],group:{class:"coverage",id:this.uuid+"coverage"},class:s.class||"floorCoverage",id:(s.uuid||"floorCoverage")+"X"+l+"Y"+c+"Z"+r,parent:this.object,position:g,type:s.type||"3d"});h.lightSources=[],this.coverage[s.id].push(h)}else{var g={};g.unit=s.unit,g.type=s.position.type||"normal",s.position&&("center"==s.position.type?(g.x=l*s.resolution+s.resolution/2+(this.width-Math.ceil(this.width/s.resolution)*s.resolution)/2,g.z=r*s.resolution+s.resolution/2+(this.depth-Math.ceil(this.depth/s.resolution)*s.resolution)/2,!s.includeY&&(g.y=s.yPlane+s.resolution/2)):(g.x=l*s.resolution,g.z=r*s.resolution,g.y=s.yPlane));var h=new Cube({width:s.squareSize||s.resolution||0.05,height:s.squareSize||s.resolution||0.05,depth:s.squareSize||s.resolution||0.05,unit:s.unit||"m",sides:s.sides||["bottom","front","top","left","right","back"],group:{class:"coverage",id:this.uuid+"coverage"},class:s.class||"floorCoverage",id:(s.uuid||"floorCoverage")+"X"+l+"Y"+Math.round(g.y)+"Z"+r,parent:this.object,position:g,type:s.type||"3d"});h.lightSources=[],this.coverage[s.id].push(h)}for(var m=0;m<this.coverage[s.id].length;m++){this.coverage[s.id][m].lumensPsqm=0;for(var v=0;v<this.lights.length;v++)this.lights[v].leds.diodes.forEach((S,C)=>{var L=C;if("center"==this.coverage[s.id][m].position.type){var P=this.lights[v].leds.diodes[L],A=this.coverage[s.id][m].position,q=CoverageAt({diode:P,x:A.x,y:A.y,z:A.z,unit:A.unit,unitScale:A.unitScale});this.coverage[s.id][m].lightSources.push(P),this.coverage[s.id][m].lumensPsqm+=q}else{for(var P=this.lights[v].leds.diodes[L],A=this.coverage[s.id][m].position,q=CoverageAt({diode:P,x:A.x,y:A.y,z:A.z,unit:A.unit,unitScale:A.unitScale}),O=[],k=0;4>k;k++){if(0==k)var M=this.coverage[s.id][m].width/2,H=this.coverage[s.id][m].depth/2;else if(1==k)var M=-1*(this.coverage[s.id][m].width/2),H=this.coverage[s.id][m].depth/2;else if(2==k)var M=this.coverage[s.id][m].width/2,H=-1*(this.coverage[s.id][m].depth/2);else if(3==k)var M=-1*(this.coverage[s.id][m].width/2),H=-1*(this.coverage[s.id][m].depth/2);O.push(CoverageAt({diode:P,x:this.coverage[s.id][m].position.x+M,y:this.coverage[s.id][m].position.y,z:this.coverage[s.id][m].position.z+H}))}var D=O.reduce((T,N)=>{},0)/O.length;this.coverage[s.id][m].lightSources.push(P),this.coverage[s.id][m].lumensPsqm+=D}}),this.coverage[s.id][m].lumens=this.coverage[s.id][m].lumensPsqm*(this.coverage[s.id][m].width*this.coverage[s.id][m].depth);var w="<div class=\"floorGridData\" id=\""+this.coverage[s.id][m].id+"data\"><div class=\"data\">Lux: "+Math.round(this.coverage[s.id][m].lumensPsqm)+"</div><div class=\"data\">Lumens: "+Math.round(this.coverage[s.id][m].lumens)+"</div></div>";$("#"+this.coverage[s.id][m].id).append(w)}for(var j=0,m=0;m<this.coverage[s.id].length;m++)this.coverage[s.id][m].lumensPsqm>j&&(j=this.coverage[s.id][m].lumensPsqm);for(var m=0;m<this.coverage[s.id].length;m++)0<j?(0<=this.coverage[s.id][m].id.indexOf("X1Y1Z0"),$("#"+this.coverage[s.id][m].scene.id+" #"+this.coverage[s.id][m].id+" > .faceParent > .face").css({opacity:this.coverage[s.id][m].lumensPsqm/(2*j)})):$("#"+this.coverage[s.id][m].scene.id+" #"+this.coverage[s.id][m].id+" > .faceParent > .face").css({opacity:1})},void 0!==o.lights)for(i=0;i<o.lights.length;i++)this.lights[o.lights[i].id]=o.lights[i];else if(void 0!==n.lights)for(i=0;i<n.lights.length;i++)this.lights[n.lights[i].id]=n.lights[i]}function GrowLight(o,n){this.height=o.height||0.06,this.width=o.width||.83,this.depth=o.depth||.26,this.unit=o.unit||"m",this.wattage=o.wattage||600,this.price=o.price,this.leds=o.leds,this.spectrum=o.spectrum,this.switches=o.switches||[],this.fans=o.fans,this.hangHeight=o.hangHeight||3.5*Math.sqrt(this.wattage),this.name=o.name||"Growlight",this.class=o.class||"growlight",jsonConcat(this,o),this.id=o.id||uuidv4(),this._id=o._id||void 0,this.uuid=o.uuid||uuidv4();var s={x:0,y:0,z:0,unit:"cm",type:"center"};this.position=o.position||s,jsonConcat(this.position,s),this.group=o.group||{id:this.uuid+"growLight-container",class:"growLight-container"},this.minPxWidth=o.minPxWidth,this.object=o.object||{},o.object&&jsonConcat(this.object,o.object),this.wattageFormatted=function(){return this.wattage+"W"},this.makeDiodes=function(l){if(this.leds||this.fillLedData(),!l)var l={};this.leds.diodes=[];var r=this.leds.ammount;for(currentType=0,quotaFilled=0,randomLedPositions=[],number=0;randomLedPositions.length<r;)0>randomLedPositions.indexOf(number)&&(randomLedPositions.push(number),this.leds.diodes.push(void 0)),number=Math.ceil(Math.random()*r-1);for(var u=0;u<this.leds.ammount;u++)for(u==Math.ceil(this.spectrum[currentType].percent*r+quotaFilled)&&(quotaFilled+=this.spectrum[currentType].percent*r,currentType++),z=0;z<this.leds.layout.zNum;z++)if(randomLedPositions[u]<this.leds.layout.xNum*z+this.leds.layout.xNum){var c={};c={x:(this.leds.layout.xNum*(z+1)-randomLedPositions[u]-1)*this.leds.layout.xPadding+this.leds.layout.xOffset,z:z*this.leds.layout.zPadding+this.leds.layout.zOffset,y:0,unit:this.leds.layout.unit||this.unit,type:"center"},c.pox=c.x<this.width/2?-(this.width/2)+c.x:c.x-this.width/2,c.poz=c.z<this.depth/2?-(this.depth/2)+c.z:c.z-this.depth/2,c.sox=this.position.x+c.pox,c.soz=this.position.z+c.poz;var g=new Diode({wavelength:this.spectrum[currentType].nm||this.spectrum[currentType].wavelength,nm:this.spectrum[currentType].nm||this.spectrum[currentType].wavelength,temperature:this.spectrum[currentType].temperature,colour:this.spectrum[currentType].colour,angle:this.spectrum[currentType].lensAngle,percent:this.spectrum[currentType].percent,ppfd:this.spectrum[currentType].ppfd,photons:this.spectrum[currentType].photons,wattage:this.spectrum[currentType].wattage,wattagePsqm:this.spectrum[currentType].wattagePsqm,lumens:this.spectrum[currentType].lumens,lux:this.spectrum[currentType].lux,id:"diodeC"+u+"d"+randomLedPositions[u]+"x"+Math.round(c.x/this.leds.layout.xPadding)+"z"+Math.round(c.z/this.leds.layout.zPadding)+"R"+Math.ceil(100*Math.random()),ammount:Math.round(this.spectrum[currentType].percent*r),position:c,render:l.render,parent:this,type:"3d",sizeSelf:!1,width:this.leds.width,depth:this.leds.depth,height:this.leds.height||this.leds.width,unit:this.leds.unit||this.unit,number:randomLedPositions[u],renderLabel:l.renderLabels||!1});this.leds.diodes[randomLedPositions[u]]=g;break}},this.getPosition=function(){for(100*this.leds.x/this.leds.padding.x*(100*this.leds.z/this.leds.padding.z),x=0;x<100*this.leds.x/this.leds.padding.x;x++)for(z=0;z<this.leds.z;z++);},this.fillLedData=function(){this.leds?(this.leds.layout.unitScale="m"==this.leds.layout.unit?1:"cm"==this.leds.layout.unit?100:"mm"==this.leds.layout.unit?1e3:"um"==this.leds.layout.unit?1e4:1,this.leds.unitScale="m"==this.leds.unit?1:"cm"==this.leds.unit?100:"mm"==this.leds.unit?1e3:"um"==this.leds.unit?1e4:1,this.leds.layout.xNum!==void 0&&this.leds.layout.zNum==void 0?this.leds.layout.zNum=Math.ceil(this.leds.ammount/this.leds.layout.xNum):(this.leds.layout.xNum==void 0&&this.leds.layout.zNum)===void 0?this.leds.layout.xNum&&this.leds.layout.zNum!==void 0&&(this.leds.layout.xNum*this.leds.layout.zNum==this.leds.ammount||this.leds.layout.xNum>this.leds.ammount&&this.leds.layout.zNum>!this.leds.ammount&&(this.leds.layout.xNum=Math.ceil(this.leds.ammount/this.leds.layout.zNum))):this.leds.layout.xNum=Math.ceil(this.leds.ammount/this.leds.layout.zNum),(this.leds.layout.width&&this.leds.layout.depth)==void 0&&this.leds.layout.xNum&&this.leds.layout.zNum&&(this.leds.layout.xPadding&&this.leds.layout.zPadding?(this.leds.layout.width=this.leds.layout.xPadding*(this.leds.layout.xNum-1),this.leds.layout.xOffset=(this.width/this.unitScale-this.leds.layout.width/this.leds.layout.unitScale)*this.leds.layout.unitScale/2,this.leds.layout.depth=this.leds.layout.zPadding*(this.leds.layout.zNum-1),this.leds.layout.zOffset=(this.depth/this.unitScale-this.leds.layout.depth/this.leds.layout.unitScale)*this.leds.layout.unitScale/2):(this.leds.layout.xPadding=this.width/this.unitScale/(this.leds.layout.xNum+1)*this.leds.layout.unitScale,this.leds.layout.zPadding=this.depth/this.unitScale/(this.leds.layout.zNum+1)*this.leds.layout.unitScale,this.leds.layout.width=this.leds.layout.xPadding*(this.leds.layout.xNum-1),this.leds.layout.xOffset=(this.width/this.unitScale-this.leds.layout.width/this.leds.layout.unitScale)*this.leds.layout.unitScale/2,this.leds.layout.depth=this.leds.layout.zPadding*(this.leds.layout.zNum-1),this.leds.layout.zOffset=(this.depth/this.unitScale-this.leds.layout.depth/this.leds.layout.unitScale)*this.leds.layout.unitScale/2))):this.leds=this.ledData()},this.coverageAt=function(l){if(!l)var l={};var r=l.lensAngle||this.lensAngle||120;return hangHeight=l.hangHeight||this.hangHeight,coverageUnit=l.unit||this.unit,l.dimension?"x"==l.dimension?(this.width/l3.ai.unitScale(this.unit)+2*(Math.atan(d2r(r/2))*hangHeight/l3.ai.unitScale(coverageUnit)))*l3.ai.unitScale(coverageUnit):"z"==l.dimension?(this.depth/l3.ai.unitScale(this.unit)+2*(Math.atan(d2r(r/2))*hangHeight/l3.ai.unitScale(coverageUnit)))*l3.ai.unitScale(coverageUnit):2*(Math.atan(d2r(r/2))*hangHeight):2*(Math.atan(d2r(r/2))*hangHeight)},this.renderObject=function(l){this.object=new Cube({height:l.height||this.height,width:l.width||this.width,depth:l.depth||this.depth,unit:l.unit||this.unit||this.object.unit,render:l.render||this.object.render||this.render,ratio:l.ratio||this.object.ratio||this.ratio||this.scene.ratio,id:uuidv4(),scene:l.scene||this.scene||this.object.scene,position:l.position||this.position||this.object.position,parent:l.parent||this.parent||this.object.parent,sizeSelf:l.sizeSelf||this.sizeSelf||this.object.sizeSelf,class:l.class||this.class||this.object.class,group:l.group||this.group||this.object.group,type:this.object.type||l.type||"3d",sides:l.sides||this.object.sides||this.sides,data:l.data||this.object.data||this.data,minPxWidth:l.minPxWidth||this.minPxWidth||this.object.minPxWidth,datas:l.datas||this.datas||[{property:"title",value:this.title},{property:"_id",value:this._id}]}),this.position=this.object.position},this.renderLabels=function(l){l.forEach((r,u)=>{var c;if(c="function"==typeof this[l[u]]?"<div class=\"labelValue\">"+this[l[u]]()+"</div>":this[l[u]]?"<div class=\"labelValue\">"+this[l[u]]+"</div>":l[u].replace(/-/g," "),0>this.object.labels.indexOf(u)){if("wattageFormatted"==l[u]){c=c.concat("<div class=\"draw-info\">draw</div>");var g=new Cube({unit:"cm",id:uuidv4()+l[u]+"Label",class:"light-label "+l[u],parent:this.object,group:{positioner:!0,id:this.uuid+"dataLabels",class:"dataLabels"},sides:[],data:{text:c,do:"openModal('"+this._id+"Modal')"}})}else if("see-the-light"!==l[u]){var g=new Cube({unit:"cm",id:uuidv4()+l[u]+"Label",class:"light-label "+l[u],parent:this.object,group:{positioner:!0,id:this.uuid+"dataLabels",class:"dataLabels"},sides:[],data:{text:c,do:"openModal('"+this._id+"Modal')"}});$("#"+this.object.group.object.id+" .see-the-light").bind("click",{obj:this},function(h){if(void 0==h.data.obj.object.group.object.transformString)var m="translate3d(0px, 0px, 0px) rotateX(0deg) rotateY(0deg) rotateZ(0deg)",v="translate3d(0px, 0px, 0px) rotateX(0deg) rotateY(0deg) rotateZ(0deg)";else{m=h.data.obj.group.object.transformString;var v="translate3d(0px, 0px, 0px) rotateX(-90deg) rotateY(0deg) rotateZ(0deg)"}if(h.data.obj.seeingTheLight){var w="translate3d(0px, 0px, 0px) rotateX(0deg) rotateY(0deg) rotateZ(0deg)";h.data.obj.object.group.object.transformString=w,h.data.obj.seeingTheLight=!1;var j="translate3d(0px, 0px, 0px) rotateX(0deg) rotateY(0deg) rotateZ(0deg)",S=104;h.data.obj.switchSpectrum({modes:"all"})}else{var w="translate3d(0px, "+-1*(h.data.obj.hangHeight/h.data.obj.unitScale/2-h.data.obj.height/8/h.data.obj.unitScale)*h.data.obj.object.scene.pxr+"px, 0px) rotateX(90deg) rotateY(0deg) rotateZ(0deg)";h.data.obj.object.group.object.transformString=w,h.data.obj.seeingTheLight=!0;var j="translate3d(0px, "+((h.data.obj.hangHeight+h.data.obj.height)/h.data.obj.unitScale+0.05)*h.data.obj.object.scene.pxr+"px,0px) rotateX(-90deg) rotateY(0deg) rotateZ(0deg)",S=400;h.data.obj.switchSpectrum({modes:[]})}var C=d3.interpolateString(m,w),L=d3.select($("#"+h.data.obj.group.object.id).get(0));L.transition().duration(1500).styleTween("transform",function(){return C});var P=d3.interpolateString(v,j),A=d3.select($("#"+h.data.obj.group.object.id+" .see-the-light").get(0));A.transition().duration(800).styleTween("transform",function(){return P}),$("#"+h.data.obj.group.object.id+" .see-the-light").toggleClass("active")})}else var g=new Cube({unit:"cm",id:uuidv4()+l[u]+"Label",class:"light-label "+l[u],parent:this.object,group:{positioner:!0,id:this.uuid+"dataLabels",class:"dataLabels"},sides:[],data:{text:c}});this.object.labels.push(g)}})},this.renderSwitches=function(l){var l=l||this.modes;this.modes=[],l.forEach((r,u)=>{this.switches.push(new Cube({width:12,height:100*(this.height/this.unitScale),depth:1,unit:"cm",type:"center",id:uuidv4()+"mode-switch",class:"mode-switch",parent:this.object,group:{positioner:!0,id:this.uuid+"mode-switches",class:"mode-switches"},data:{text:"<div id=\""+this.uuid+"-spectrum-switches\" class=\"material-toggle spectrum-switches "+l[u]+"-toggle-container\"> <div class=\"light-btn-label "+l[u]+"-spectrum\">"+l[u]+"</div><input type=\"checkbox\", id=\""+this.uuid+"-"+l[u]+"-toggle\", name=\""+this.uuid+"-"+l[u]+"-toggle\", checked=true></input><label id=\""+this.uuid+l[u]+"label\", for=\""+this.uuid+"-"+l[u]+"-toggle\", class=\""+l[u]+"-label spectrum-label\"></label></div>"}})),this.modes[l[u]]=!0,$("#"+this.uuid+l[u]+"label").bind("click",{obj:this},function(c){var g=c.target.className.split("-")[0];c.data.obj.modes[g]=!c.target.control.checked,c.data.obj.switchSpectrum()})})},this.renderLight=function(l){if(!l)var l={};this.light={},this.lightEdgeOffset=2,edgeOffset=this.lightEdgeOffset,C=0,emitWidth=this.width-edgeOffset,this.hangHeight=l.hangHeight||this.hangHeight||this.wattage/6||60;var u=l.zIndex||14,c=!0,g=[],h=[],m=0;this.spectrum.forEach(L=>{L.lensAngle>m&&(m=L.lensAngle)}),this.light.totalWidth=2*(Math.sqrt(Math.pow(Math.tan(d2r(m/2)),2))*this.hangHeight)+emitWidth;var v=this.light.totalWidth;this.light.offsetWidth=(v-emitWidth)/2;var w=this.light.offsetWidth,j=.15;this.spectrum.forEach((L,P)=>{var A=L,q=A.wavelength||A.temperature,O=l.lensAngle||A.lensAngle||this.lensAngle||120,k=A.lightOpacity||0.6,H=[200,200,200];if("auto"!==A.percent)var D=A.percent;else if("auto"==A.percent)var D=1/this.spectrum.length;if(!this.centerOutWavelengths)u++;else if(P+1<this.spectrum.length/2)++u;else if(P+1>=this.spectrum.length/2)if(!0==c){++u;var T="source-over";c=!1}else{--u;var T="destination-over"}if(1e3>q){if(q="nm"+q,grow.ai.wavelengthColourCodes[q]){H=grow.ai.wavelengthColourCodes[q].rgbObj;var N="rgba("+H.r+","+H.g+","+H.b+","+k+")"}}else if(1e3<q){if(q="k"+q,grow.ai.wavelengthColourCodes[q]){H=grow.ai.wavelengthColourCodes[q].rgbObj;var N="rgba("+H.r+","+H.g+","+H.b+","+k+")"}}else if(grow.ai.wavelengthColourCodes[q]){H=grow.ai.wavelengthColourCodes[q].rgbObj;var N="rgba("+H.r+","+H.g+","+H.b+","+k+")"}else var N="rgba("+H.r+","+H.g+","+H.b+","+k+")";if(this.backBoost){var N=N.replace(/,.{3}\)/,",0.7)");if("Green"==q){var N=N.replace(/,.{3}\)/,",0.7)"),E=N.replace(/,.{3}\)/,",0.4)");g.push({points:[{x:w+emitWidth*C,y:0},{x:w+emitWidth*C+emitWidth*D,y:0},{x:w+emitWidth*C+(emitWidth*D+Math.sqrt(Math.pow(Math.tan(d2r(O/2)),2))*this.hangHeight),y:this.hangHeight},{x:w+emitWidth*C+-1*(Math.sqrt(Math.pow(Math.tan(d2r(O/2)),2))*this.hangHeight),y:this.hangHeight}],fillStyle:E,composite:"destination-over",zIndex:13,countOnHover:!1,wavelength:q,id:uuidv4()})}else{var E=N.replace(/,.{3}\)/,",0.8)"),N=N.replace(/,.{3}\)/,","+j+")");j+=0.15,h.push({points:[{x:w+emitWidth*C,y:0},{x:w+emitWidth*C+emitWidth*D,y:0},{x:w+emitWidth*C+(emitWidth*D+Math.sqrt(Math.pow(Math.tan(d2r(O/2)),2))*this.hangHeight),y:this.hangHeight},{x:w+emitWidth*C+-1*(Math.sqrt(Math.pow(Math.tan(d2r(O/2)),2))*this.hangHeight),y:this.hangHeight}],fillStyle:E,composite:"destination-over",zIndex:13,countOnHover:!1,wavelength:q,id:uuidv4()})}g.push({points:[{x:w+emitWidth*C,y:0},{x:w+emitWidth*C+emitWidth*D,y:0},{x:w+emitWidth*C+(emitWidth*D+Math.sqrt(Math.pow(Math.tan(d2r(O/2)),2))*this.hangHeight),y:this.hangHeight},{x:w+emitWidth*C+-1*(Math.sqrt(Math.pow(Math.tan(d2r(O/2)),2))*this.hangHeight),y:this.hangHeight}],fillStyle:N,composite:T,zIndex:u,countOnHover:!0,wavelength:q,id:uuidv4()})}else g.push({points:[{x:w+emitWidth*C,y:0},{x:w+emitWidth*C+emitWidth*D,y:0},{x:w+emitWidth*C+(emitWidth*D+Math.sqrt(Math.pow(Math.tan(d2r(O/2)),2))*this.hangHeight),y:this.hangHeight},{x:w+emitWidth*C+-1*(Math.sqrt(Math.pow(Math.tan(d2r(O/2)),2))*this.hangHeight),y:this.hangHeight}],fillStyle:N,composite:T,zIndex:u,countOnHover:!0,wavelength:q,id:uuidv4()});C+=D}),this.backBoost&&h.forEach(L=>{g.push(L)}),this.light.object=new Cube({sides:[],height:this.hangHeight,width:emitWidth,unit:this.unit,group:{id:this.uuid+"growLight-container",class:"growLight-container"},id:uuidv4(),parent:this.object.parent,position:this.width/2,scene:this.object.scene,class:"light",type:"canvas",canvas:{type:"polygons",paths:g,size:{width:!0,height:!0},width:v}});var S=this.light;this.light.object.canvas.canvas.onmousemove=function(L){var P=parseInt(L.offsetX),A=parseInt(L.offsetY),q=l3.ai.findCurrentPath({mouse:{x:P,y:A},paths:S.object.canvas.paths});if(q){var O=$("#"+S.object.id+" ."+q.wavelength);for(path in O.css("opacity",1),S.object.canvas.paths){var k=S.object.canvas.paths;if(k.hasOwnProperty(path)){var M=k[path];if(M.id!==q.id){var H=$("#"+S.object.id+" ."+M.wavelength);H.css("opacity",0)}}}}else setTimeout(()=>{for(path in S.object.canvas.paths){var D=S.object.canvas.paths;if(D.hasOwnProperty(path)){var T=D[path],N=$("#"+S.object.id+" ."+T.wavelength);N.css("opacity",0)}}},300)};var C=0;this.spectrum.forEach(L=>{var A=L.wavelength||L.temperature,q=A,O=l3.propToString(L,A);if(1e3>A?(A="nm"+A,q+="nm"):1e3<A&&(A="k"+A,q+="k"),"auto"!==L.percent)var k=L.percent;else if("auto"==L.percent)var k=1/this.spectrum.length;var M="<div class=\"wavelengthLabel\">  <span class=\"valueLabel\">"+O+": </span><span class=\"value wavelength\">"+q+" </span> </div><div class=\"wavelengthLabel\"> <span class=\"value percent\"> "+(100*k).toFixed(1)+"</span><span class=\"valueLabel\">%</span>  </div> <div class=\"wavelengthLabel\"> <span class=\"value wattagePercent\"> "+(k*this.wattage).toFixed(1)+"</span><span class=\"valueLabel\">W</span>  </div>";new Cube({id:uuidv4(),class:"wavelengthLabelObj "+A,parent:this.light.object,sides:[],unit:"cm",position:{x:C*emitWidth+(this.object.width-emitWidth)/2+emitWidth*L.percent/2},group:{class:"spectrumLabels",id:this.light.object.id+"spectrumLabels"},data:{text:M}}),C+=L.percent})},this.switchSpectrum=function(l){if(l){var r=l.mode;on=l.on,"all"===l.modes?this.modes.forEach(()=>{this.modes[r]=!0}):(this.modes.forEach(()=>{this.modes[r]=!1}),l.modes.forEach(()=>{this.modes[r]=!0}))}else var l={};if(this.light){var u=0;edgeOffset=this.lightEdgeOffset,filled=0,emitWidth=this.width-edgeOffset,this.hangHeight=this.hangHeight||l.hangHeight||this.wattage/6||60,highestPercentage=0,this.spectrum.forEach((h,m)=>{var v=0;this.spectrum[m].modes?this.spectrum[m].modes.forEach((w,j)=>{this.modes[this.spectrum[m].modes[j].title]&&"auto"!==v+this.spectrum[m].modes[j].percent&&(v+this.spectrum[m].modes[j].percent<=this.spectrum[m].percent&&(v+=this.spectrum[m].modes[j].percent,u+=this.spectrum[m].modes[j].percent),v>highestPercentage&&(highestPercentage=v))}):(u=1,highestPercentage=u/this.spectrum.length)});var c=[];if(0==u)this.light.object.canvas.paths&&this.light.object.canvas.paths.forEach(h=>{var v={};jsonConcat(v,h),v.points=[{x:h.points[0].x,y:h.points[0].y},{x:h.points[1].x,y:h.points[1].y},{x:h.points[1].x-(h.points[1].x-h.points[0].x)/1.5,y:0},{x:h.points[1].x-(h.points[1].x-h.points[0].x)/2.5,y:0}],c.push(v)});else{var g=[];this.spectrum.forEach((h,m)=>{this.backBoost&&(S=" backBoosted");var v=h.lensAngle,w=[200,200,200],j=h.wavelength||h.temperature,S="",C=h.lightOpacity,v=h.lensAngle||this.lensAngle||l.lensAngle||120,P=0;if(1e3>j){if(j="nm"+j,grow.ai.wavelengthColourCodes[j]){w=grow.ai.wavelengthColourCodes[j].rgbObj;var A="rgba("+w.r+","+w.g+","+w.b+","+C+")"}}else if(1e3<j){if(j="k"+j,grow.ai.wavelengthColourCodes[j]){w=grow.ai.wavelengthColourCodes[j].rgbObj;var A="rgba("+w.r+","+w.g+","+w.b+","+C+")"}}else if(grow.ai.wavelengthColourCodes[j]){w=grow.ai.wavelengthColourCodes[j].rgbObj;var A="rgba("+w.r+","+w.g+","+w.b+","+C+")"}else var A="rgba("+w.r+","+w.g+","+w.b+","+C+")";h.modes?h.modes.forEach((M,H)=>{this.modes[h.modes[H].title]&&P+h.modes[H].percent<=h.percent&&(P+=h.modes[H].percent)}):"auto"===h.percent?P=h.percent:P=1/this.spectrum.length;var q=[{x:this.light.offsetWidth+emitWidth*filled,y:0},{x:this.light.offsetWidth+emitWidth*filled+emitWidth*(P/u),y:0},{x:this.light.offsetWidth+emitWidth*filled+(emitWidth*(P/u)+Math.tan(d2r(v/2))*this.hangHeight),y:this.hangHeight},{x:this.light.offsetWidth+emitWidth*filled+-1*(Math.tan(d2r(v/2))*this.hangHeight),y:this.hangHeight}];g.push(q);var O=d3.select($("#"+this.light.object.children[m].id+" .percent").get(0));O.html((100*(P/u)).toFixed(1));var k=d3.select($("#"+this.light.object.children[m].id+" .wattagePercent").get(0));k.html((P*this.wattage).toFixed(1)),filled+=P/u}),this.backBoost&&g.forEach(h=>{g.push(h)}),this.light.object.canvas.paths.forEach((h,m)=>{var v={};jsonConcat(v,h),v.points=g[m],c.push(v)})}this.light.object.canvas.paths&&(0===u?0==u?this.light.object.redraw({transition:{duration:500,ease:d3.easeCubic},canvas:{paths:c}}):this.light.object.redraw({transition:{duration:500,ease:d3.easeCubic},canvas:{paths:c}}):this.light.object.redraw({transition:{duration:500,ease:d3.easeCubic},canvas:{paths:c}})),d3.select($("#"+this.object.id+" .light-label.wattageFormatted .labelValue").get(0)).html(Math.round(this.wattage*u)+"W")}},this.createCoverageMap=function(l){if(!l)var l={};this.coverageMaps||(this.coverageMaps=[]);var r={unit:l.unit||this.unit||"cm",width:l.width||this.coverageAt({dimension:"x"}),depth:l.depth||this.coverageAt({dimension:"z"}),height:l.height,xResolution:l.xResolution||l.resolution||10,zResolution:l.zResolution||l.resolution||10,yResolution:l.yResolution||l.resolution||10,map:[],type:l.type||"2d",uuid:uuidv4(),maxLumens:0};r.width=Math.floor(r.width/r.xResolution)*r.xResolution,r.depth=Math.floor(r.depth/r.zResolution)*r.zResolution,r.object=new Cube({width:r.width,height:0,depth:r.depth,unit:r.unit,type:"2d",sides:["bottom"],scene:this.object.scene,group:{id:this.object.group.id,class:"growLight-container"},class:"coverageMap",id:uuidv4(),position:{z:0,x:0,type:"center",unit:r.unit}}),l.dimensionLabels&&r.object.children.push(new Cube({width:r.width,height:5,sides:[],unit:r.unit,id:uuidv4()+"coverageMapLabel",class:"coverageMapFullLabel width",data:{text:"<div class=\"data\">"+r.width+r.unit+"</div>"},parent:r.object,position:{rx:-90,y:-3}}),new Cube({width:r.width,height:5,sides:[],unit:r.unit,id:uuidv4()+"coverageMapLabel",class:"coverageMapFullLabel depth",data:{text:"<div class=\"data\">"+r.depth+r.unit+"</div>"},parent:r.object,position:{rx:-90,x:-1*(r.width/2),z:1*(r.depth/2),y:-3}}));for(var c,u=0;u<=r.width-r.xResolution;u+=r.xResolution){c=u;for(var h,g=0;g<=r.depth-r.zResolution;g+=r.zResolution)if(h=g,"3d"==r.type)for(var v,m=0;m<=r.height-r.yResolution;m+=r.yResolution)v=m;else{var j,S,w=grow.ai.energyAt({lightUnit:"lumens",target:{x:c+r.xResolution/2-r.width/2,z:h+r.zResolution/2-r.depth/2,unit:r.unit},lightSource:this});r.maxLumens<w&&(r.maxLumens=w);var C=r.xResolution*r.zResolution,L=new Cube({id:uuidv4()+"coverageMapSquare",class:"coverageMapSquare d2",width:r.xResolution,depth:r.zResolution,height:r.zResolution,unit:r.unit,sides:["bottom"],position:{x:c,z:h,unit:r.unit},type:"2d",parent:r.object,group:{id:this.uuid+"coverageMap",class:"coverageMap"},data:{lumens:w||0,ppfd:S||0,lux:j||0,area:C}});r.map.push(L);new Cube({id:uuidv4(),sides:[],class:"coverageSquareData",data:{text:"<div>X: "+Math.round(c+r.xResolution/2)+r.unit+" Z: "+Math.round(h+r.zResolution/2)+r.unit+"</div><div>Width: "+Math.round(r.xResolution)+r.unit+" Depth: "+Math.round(r.zResolution)+r.unit+"</div><div class=\"area\">"+(C/(100*l3.ai.unitScale(r.unit))).toFixed(2)+"m<span class=\"squared\">2</span></div><div>Hang Height: "+this.hangHeight+this.unit+"</div><div>Lumens: "+w+"</div><div class=\"lux\">Lux: "+w+"</div>",area:C},position:{z:2*r.zResolution,x:r.xResolution/2,y:-15,rx:-90},parent:L})}}r.map.forEach(A=>{var O=A;d3.select($("#"+O.id+">.bottom").get(0)).transition().duration(2e3).style("opacity",O.data.lumens/r.maxLumens),d3.select($("#"+O.id+" .coverageSquareData .lux").get(0)).html("Lux: "+Math.round(1e4/O.data.area*O.data.lumens))})},this.renderCoverage=function(l){this.createCoverageMap(l)},this.ledCount=function(){return this.wattage*(1/this.ledEfficiency)/this.ledWattage},this.leds={ammount:this.ledCount()||this.wattage*(1/this.ledEfficiency)/this.ledWattage||30,layout:{xNum:Math.ceil(Math.sqrt(this.ledCount())*(100*(this.width/this.unitScale))/this.depth),zNum:Math.ceil(Math.sqrt(this.ledCount())*(100*(this.depth/this.unitScale))/this.width),unit:"cm"},unit:"cm",width:1,depth:1},this.leds&&(this.fillLedData(),this.makeDiodes({render:!1})),this.renderRules&&(this.renderRules.object&&this.scene&&(this.renderObject({sides:this.object.sides||["front","bottom","left","right","top","back"],type:this.object.type||"3d",scene:this.object.scene||this.scene,sizeSelf:this.object.sizeSelf||!0,ratio:o.ratio||this.object.ratio||this.ratio||this.scene.ratio,class:this.object.class||"growLight "+this.model+" "+this.wattage+"watts",position:{unit:this.unit}}),this.renderRules.switches&&this.renderSwitches(),this.renderRules.light&&this.renderLight(),this.renderRules.labels&&this.renderLabels(this.renderRules.labels),this.renderRules.diodes&&this.makeDiodes()),this.renderRules.diodeData&&this.makeDiodes({render:!1})),n&&n.makeDiodes&&this.makeDiodes({render:!1})}function Diode(o){this.wavelength=o.wavelength,this.nm=o.nm,this.temperature=o.temperature,this.colour=o.colour,this.ratio=o.ratio||o.percent,this.percent=o.percent||o.ratio,this.angle=o.angle||120,this.par=o.par,this.ppfd=o.ppfd,this.lumens=o.lumens,this.lux=o.lux,this.wattage=o.wattage,this.wattagePsqm=o.wattagePsqm,this.ammount=o.ammount||1,this.position={x:0,y:0,z:0,unit:"cm",type:"center",layout:o.layout||o.parent.leds.layout},jsonConcat(this.position,o.position),this.position.unitScale=l3.ai.unitScale(this.position.unit),this.parent=o.parent,this.id=o.id,this.number=o.number,this.width=o.width||2e-3,this.height=o.height||2e-3,this.depth=o.depth||2e-3,this.unit=o.unit||"m",this.unitScale=l3.ai.unitScale(this.unit),!1!==o.render&&(this.object=o.object||new Cube({width:o.width||.002,height:o.height||.002,depth:o.depth||.002,unit:o.unit||"m",position:this.position,id:o.id,class:o.class||"diode",group:o.group||{id:o.parent.object.uuid+"diodes",class:"diodes"},type:o.type||"3d",sides:o.sides||["front","bottom"],parent:o.parent.object,scene:o.parent.scene||o.scene,sizeSelf:o.sizeSelf||!1,render:o.render})),this.hitsSpot=function(){},this.renderLabel=function(){if(this.object){this.object.children.push(new Cube({width:30,height:30,position:{y:-20,rx:-90},id:uuidv4(),class:"diodeLabel",parent:this.object,data:{text:"<div>  <div>X: "+this.position.x+" </div> <div>Z: "+this.position.z+" </div>    </div>"},sides:[]}))}},o.renderLabel&&this.renderLabel()}function getTanDeg(o){var n=o*Math.PI/180;return Math.tan(n)}function CoverageAt(o){this.energyAtPoint=function(u,c,g){var h=10*(Math.pow(c,1+3.8317)/Math.pow(Math.sqrt(Math.pow(u,2)+Math.pow(g,2)+Math.pow(c,2)),3+3.8317));return h};var n=o.diode.position.oy/o.diode.position.unitScale-o.y/o.unitScale;if(0>n)return 0;var s=o.diode.position.oz/o.diode.position.unitScale-o.z/o.unitScale,l=o.diode.position.ox/o.diode.position.unitScale-o.x/o.unitScale;return this.energyAtPoint(l,n,s)}function Plant(){function n(c,g){var h=c.split(","),m=0>g?0:255,v=0>g?-1*g:g,w=parseInt(h[0].slice(4)),j=parseInt(h[1]),S=parseInt(h[2]);return"rgb("+(Math.round((m-w)*v)+w)+","+(Math.round((m-j)*v)+j)+","+(Math.round((m-S)*v)+S)+")"}const s="http://www.w3.org/2000/svg";(()=>{const m=0.7,v=Math.PI/1.6,j=document.getElementById("svg"),C=10,L=2,P=2*Math.PI;let A=0;const O=2,k=({x:W,y:F,idx:I})=>{let Y=8,X=0,Z=!0,U=1,_=0.5,V=0;const Q=document.createElementNS(s,"use");Q.setAttribute("href","#flower"),Q.setAttribute("style","z-index: -1");const K={idx:I,grow(){X+=1,_+=0.1*Math.random()},drop(){F+=L*Math.random(),W+=L*(Math.random()-0.5)+A,V+=P*(Math.random()-0.5)},transform(){const te=_*C/2;Q.setAttribute("transform",`translate(${W-te},${F-te}) scale(${_}) rotate(${V})`)},step(){return F>=window.innerHeight-2*C?Y-=1:X>=10?Z?(Z=Math.random()<Math.pow(0.9999,U),U+=1e-5):this.drop():this.grow(),this.transform(),Y},delete(){j.removeChild(Q)}};K.transform();const{childNodes:J}=j,ee=J[Math.ceil(Math.random()*J.length)];return j.insertBefore(Q,ee),K},M=W=>{const F={};let I=[];const Y=()=>{for(let U=0;U<W.length;U++){const _=Math.ceil(Math.random()*W.length);if(!F[_])return F[_]=!0,_}return-1},X=()=>{const U=Y();if(0<=U){const _=W[U];I.push(k(Object.assign({},_,{idx:U})))}},Z=()=>{I=I.reduce((U,_)=>{return 0<_.step()?U.concat([_]):(_.delete(),delete F[_.idx],U)},[]),[,,,,,].fill().forEach(()=>{0.02>Math.random()&&X()}),0.02>Math.random()&&(A=Math.min(O,A+(2*Math.random()-1)*1),A=Math.max(-O,A)),requestAnimationFrame(Z)};requestAnimationFrame(Z)},H=W=>Array.isArray(W)?W:[W],D=W=>{if(!Array.isArray(W))return W;const[F,I]=W;return H(F).concat(H(I))},T=(W,F,I,Y,X,Z,U)=>{const _=W+I*Math.cos(Y),V=F+I*Math.sin(Y),Q=document.createElementNS(s,"line"),K=`stroke:${U};stroke-width:${Z};z-index:1;`;Q.setAttribute("x1",W),Q.setAttribute("x2",_),Q.setAttribute("y1",F),Q.setAttribute("y2",V),Q.setAttribute("style",K),j.appendChild(Q);const J=X-1;if(0>=J)return Promise.resolve({x:_,y:V});const te=n(U,0.04);return Promise.map([-1,1],ie=>{const oe=Y+v*(0.5*Math.random()*ie),ae=I*(m+Math.random()*(1-m));return new Promise(ne=>{setTimeout(()=>ne(T(_,V,ae,oe,J,Z*m,te)),600)})}).then(D)},N=(W,F)=>{return T(Math.ceil(window.innerWidth/2),Math.ceil(window.innerHeight/1.02),60,-Math.PI/2,W,F,"rgb(139, 221, 35)")};(()=>{j.setAttribute("width",window.innerWidth),j.setAttribute("height",window.innerHeight),N(8,10).then(M)})()})()}